<!doctype html>
<html lang="es" data-theme="ocean">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-i18n="pageTitle">Panel Telegram Scraper</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
  </head>
  <body>
    <main class="page">
      <section class="hero card">
        <div class="hero-top">
          <div>
            <p class="eyebrow">Telegram MTProto</p>
            <h1 data-i18n="heroTitle">Panel de Control</h1>
            <p class="lede" data-i18n="heroLede">
              Ejecuta scraping incremental, dry-run, backfill y exportes desde esta interfaz.
            </p>
          </div>
          <div class="toolbar" role="group" aria-label="Preferencias">
            <div class="toolbar-field">
              <label for="languageSwitcher" data-i18n="languageLabel">Idioma</label>
              <select id="languageSwitcher" aria-label="Language">
                <option value="es" data-i18n="langSpanish">Español</option>
                <option value="en" data-i18n="langEnglish">English</option>
              </select>
            </div>
            <div class="toolbar-field">
              <label for="themeSwitcher" data-i18n="themeLabel">Color</label>
              <select id="themeSwitcher" aria-label="Theme">
                <option value="ocean" data-i18n="themeOcean">Océano</option>
                <option value="amber" data-i18n="themeAmber">Ámbar</option>
                <option value="graphite" data-i18n="themeGraphite">Grafito</option>
              </select>
            </div>
          </div>
        </div>
        <div class="metrics">
          <article>
            <span class="label" data-i18n="metricTargetsDb">Targets en DB</span>
            <strong>{{ total_targets }}</strong>
          </article>
          <article>
            <span class="label" data-i18n="metricMessagesStored">Mensajes guardados</span>
            <strong>{{ total_messages }}</strong>
          </article>
          <article>
            <span class="label" data-i18n="metricConfigTargets">Targets configurados</span>
            <strong>{{ config_targets | length }}</strong>
          </article>
        </div>
      </section>

      <section class="grid">
        <article class="card">
          <h2 data-i18n="scrapeTitle">Ejecutar Scrape</h2>
          <form action="/scrape" method="post" class="stack">
            <label for="target" data-i18n="singleTargetLabel">Target único (opcional)</label>
            <input
              id="target"
              name="target"
              type="text"
              placeholder="@canal o https://t.me/canal"
              data-i18n-placeholder="singleTargetPlaceholder"
              autocomplete="off"
            />

            <label class="check">
              <input type="checkbox" name="backfill" />
              <span data-i18n="backfillLabel">Backfill histórico (hasta el límite configurado)</span>
            </label>
            <label class="check">
              <input type="checkbox" name="dry_run" />
              <span data-i18n="dryRunLabel">Solo dry-run (resuelve targets, no scrapea)</span>
            </label>
            <button type="submit" data-i18n="startScrapeBtn">Iniciar Scrape</button>
          </form>
          <p class="hint" data-i18n="scrapeHint">
            Solo soporta targets públicos o chats a los que tu cuenta tenga acceso legítimo.
          </p>
        </article>

        <article class="card">
          <h2 data-i18n="exportTitle">Exportar Mensajes</h2>
          <form action="/export" method="post" class="stack">
            <label for="format" data-i18n="formatLabel">Formato</label>
            <select id="format" name="format">
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
            </select>
            <button type="submit" data-i18n="downloadBtn">Descargar Export</button>
          </form>
          <p class="hint" data-i18n="exportHint">
            Exporta toda la tabla de mensajes desde SQLite.
          </p>
        </article>
      </section>

      <section class="card">
        <h2 data-i18n="manualTitle">Manual rápido</h2>
        <ol class="manual-list">
          <li data-i18n="manualStep1">Configura tus credenciales en `.env`.</li>
          <li data-i18n="manualStep2">Define `targets` en `config.json`.</li>
          <li data-i18n="manualStep3">Primero ejecuta `Dry-run` para validar accesos.</li>
          <li data-i18n="manualStep4">Ejecuta scrape incremental sin backfill para uso diario.</li>
          <li data-i18n="manualStep5">Usa backfill solo cuando necesites histórico inicial.</li>
          <li data-i18n="manualStep6">Exporta en CSV/JSON cuando necesites análisis externo.</li>
        </ol>
        <a class="manual-link" href="/manual" target="_blank" rel="noopener" data-i18n="manualOpenLink">
          Abrir manual completo
        </a>
      </section>

      {% if scrape_error %}
      <section class="card alert error">
        <h2 data-i18n="scrapeErrorTitle">Error de Scrape</h2>
        <p>{{ scrape_error }}</p>
      </section>
      {% endif %}

      {% if scrape_summary %}
      <section class="card alert ok">
        <h2 data-i18n="summaryTitle">Resumen de última ejecución</h2>
        <div class="summary">
          <span><span data-i18n="summaryModeLabel">Modo</span>: <strong>{{ scrape_summary.mode }}</strong></span>
          <span><span data-i18n="summaryTargetsOkLabel">Targets OK</span>: <strong>{{ scrape_summary.targets_ok }}/{{ scrape_summary.targets_total }}</strong></span>
          <span><span data-i18n="summaryTargetsFailedLabel">Targets fallidos</span>: <strong>{{ scrape_summary.targets_failed }}</strong></span>
          <span><span data-i18n="summaryNewMessagesLabel">Mensajes nuevos</span>: <strong>{{ scrape_summary.messages_new }}</strong></span>
          <span><span data-i18n="summaryFloodWaitsLabel">Flood waits</span>: <strong>{{ scrape_summary.flood_waits }}</strong></span>
        </div>

        {% if scrape_summary.dry_run_items %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-i18n="dryInput">Input</th>
                <th data-i18n="dryTargetId">Target ID</th>
                <th data-i18n="dryResolved">Resuelto</th>
                <th data-i18n="dryLastMessageId">Último Message ID</th>
              </tr>
            </thead>
            <tbody>
              {% for item in scrape_summary.dry_run_items %}
              <tr>
                <td>{{ item.input_target }}</td>
                <td>{{ item.resolved_target_id }}</td>
                <td>{{ item.resolved_username or item.resolved_title or "-" }}</td>
                <td>{{ item.last_message_id }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>
      {% endif %}

      <section class="grid">
        <article class="card">
          <h2 data-i18n="configuredTargetsTitle">Targets configurados</h2>
          {% if config_error %}
          <p class="small error-text">{{ config_error }}</p>
          {% elif not config_targets %}
          <p class="small" data-i18n="noTargetsConfigured">No hay targets configurados.</p>
          {% else %}
          <ul class="list">
            {% for target in config_targets %}
            <li>{{ target }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </article>

        <article class="card">
          <h2 data-i18n="pathsTitle">Rutas</h2>
          <ul class="list mono">
            <li>DB: {{ db_path }}</li>
            <li>Config: {{ config_path }}</li>
            <li>Env: {{ env_path }}</li>
          </ul>
        </article>
      </section>

      <section class="card">
        <h2 data-i18n="targetsStatsTitle">Estadísticas de targets</h2>
        {% if not target_rows %}
        <p class="small" data-i18n="noTargetData">Aún no hay datos de targets.</p>
        {% else %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-i18n="tableTarget">Target</th>
                <th data-i18n="tableTargetId">Target ID</th>
                <th data-i18n="tableMessages">Mensajes</th>
                <th data-i18n="tableLastMessageId">Último Message ID</th>
                <th data-i18n="tableLastScrapedAt">Último scrapeo</th>
              </tr>
            </thead>
            <tbody>
              {% for row in target_rows %}
              <tr>
                <td>{{ row.target_username or row.title or row.target_input }}</td>
                <td>{{ row.target_id }}</td>
                <td>{{ row.total_messages }}</td>
                <td>{{ row.last_message_id or 0 }}</td>
                <td>{{ row.last_scraped_at or "never" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>

      <section class="card">
        <h2 data-i18n="recentRunsTitle">Ejecuciones recientes</h2>
        {% if not recent_runs %}
        <p class="small" data-i18n="noRunsRegistered">No hay ejecuciones registradas.</p>
        {% else %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th data-i18n="tableMode">Modo</th>
                <th data-i18n="tableTargetFilter">Filtro target</th>
                <th data-i18n="tableTargetsOk">Targets OK</th>
                <th data-i18n="tableMessagesNew">Mensajes nuevos</th>
                <th data-i18n="tableFloodWaits">Flood waits</th>
                <th data-i18n="tableFinished">Finalizado</th>
              </tr>
            </thead>
            <tbody>
              {% for run in recent_runs %}
              <tr>
                <td>{{ run.id }}</td>
                <td>{{ run.mode }}</td>
                <td>{{ run.target_filter or "-" }}</td>
                <td>{{ run.targets_ok }}/{{ run.targets_total }}</td>
                <td>{{ run.messages_new }}</td>
                <td>{{ run.flood_waits }}</td>
                <td>{{ run.finished_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>
    </main>
    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
  </body>
</html>
