<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Telegram Scraper Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
  </head>
  <body>
    <main class="page">
      <section class="hero card">
        <p class="eyebrow">Telegram MTProto</p>
        <h1>Scraper Control Panel</h1>
        <p class="lede">
          Run incremental scraping, dry-runs, backfills, and exports from a visual dashboard.
        </p>
        <div class="metrics">
          <article>
            <span class="label">Targets in DB</span>
            <strong>{{ total_targets }}</strong>
          </article>
          <article>
            <span class="label">Messages Stored</span>
            <strong>{{ total_messages }}</strong>
          </article>
          <article>
            <span class="label">Config Targets</span>
            <strong>{{ config_targets | length }}</strong>
          </article>
        </div>
      </section>

      <section class="grid">
        <article class="card">
          <h2>Run Scrape</h2>
          <form action="/scrape" method="post" class="stack">
            <label for="target">Single target (optional)</label>
            <input
              id="target"
              name="target"
              type="text"
              placeholder="@channel or https://t.me/channel"
              autocomplete="off"
            />

            <label class="check">
              <input type="checkbox" name="backfill" />
              Backfill history (up to configured limit)
            </label>
            <label class="check">
              <input type="checkbox" name="dry_run" />
              Dry-run only (resolve targets, do not scrape)
            </label>
            <button type="submit">Start Scrape</button>
          </form>
          <p class="hint">
            Supports public targets or chats your account can access legitimately.
          </p>
        </article>

        <article class="card">
          <h2>Export Messages</h2>
          <form action="/export" method="post" class="stack">
            <label for="format">Format</label>
            <select id="format" name="format">
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
            </select>
            <button type="submit">Download Export</button>
          </form>
          <p class="hint">
            Exports complete messages table from SQLite.
          </p>
        </article>
      </section>

      {% if scrape_error %}
      <section class="card alert error">
        <h2>Scrape Error</h2>
        <p>{{ scrape_error }}</p>
      </section>
      {% endif %}

      {% if scrape_summary %}
      <section class="card alert ok">
        <h2>Last Run Summary</h2>
        <div class="summary">
          <span>Mode: <strong>{{ scrape_summary.mode }}</strong></span>
          <span>Targets OK: <strong>{{ scrape_summary.targets_ok }}/{{ scrape_summary.targets_total }}</strong></span>
          <span>Targets Failed: <strong>{{ scrape_summary.targets_failed }}</strong></span>
          <span>New Messages: <strong>{{ scrape_summary.messages_new }}</strong></span>
          <span>Flood Waits: <strong>{{ scrape_summary.flood_waits }}</strong></span>
        </div>

        {% if scrape_summary.dry_run_items %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Input</th>
                <th>Target ID</th>
                <th>Resolved</th>
                <th>Last Message ID</th>
              </tr>
            </thead>
            <tbody>
              {% for item in scrape_summary.dry_run_items %}
              <tr>
                <td>{{ item.input_target }}</td>
                <td>{{ item.resolved_target_id }}</td>
                <td>{{ item.resolved_username or item.resolved_title or "-" }}</td>
                <td>{{ item.last_message_id }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>
      {% endif %}

      <section class="grid">
        <article class="card">
          <h2>Configured Targets</h2>
          {% if config_error %}
          <p class="small error-text">{{ config_error }}</p>
          {% elif not config_targets %}
          <p class="small">No targets configured.</p>
          {% else %}
          <ul class="list">
            {% for target in config_targets %}
            <li>{{ target }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </article>

        <article class="card">
          <h2>Paths</h2>
          <ul class="list mono">
            <li>DB: {{ db_path }}</li>
            <li>Config: {{ config_path }}</li>
            <li>Env: {{ env_path }}</li>
          </ul>
        </article>
      </section>

      <section class="card">
        <h2>Targets Stats</h2>
        {% if not target_rows %}
        <p class="small">No target data yet.</p>
        {% else %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Target</th>
                <th>Target ID</th>
                <th>Messages</th>
                <th>Last Message ID</th>
                <th>Last Scraped At</th>
              </tr>
            </thead>
            <tbody>
              {% for row in target_rows %}
              <tr>
                <td>{{ row.target_username or row.title or row.target_input }}</td>
                <td>{{ row.target_id }}</td>
                <td>{{ row.total_messages }}</td>
                <td>{{ row.last_message_id or 0 }}</td>
                <td>{{ row.last_scraped_at or "never" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>

      <section class="card">
        <h2>Recent Runs</h2>
        {% if not recent_runs %}
        <p class="small">No runs registered.</p>
        {% else %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Mode</th>
                <th>Target filter</th>
                <th>Targets OK</th>
                <th>Messages New</th>
                <th>Flood Waits</th>
                <th>Finished</th>
              </tr>
            </thead>
            <tbody>
              {% for run in recent_runs %}
              <tr>
                <td>{{ run.id }}</td>
                <td>{{ run.mode }}</td>
                <td>{{ run.target_filter or "-" }}</td>
                <td>{{ run.targets_ok }}/{{ run.targets_total }}</td>
                <td>{{ run.messages_new }}</td>
                <td>{{ run.flood_waits }}</td>
                <td>{{ run.finished_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>
    </main>
  </body>
</html>

