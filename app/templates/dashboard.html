<!doctype html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-i18n="pageTitle">Multi-Source Scraper Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
  </head>
  <body>
    <header class="topnav card">
      <div class="topnav-brand">
        <p class="eyebrow">Data Intake Workspace</p>
        <h1 data-i18n="navTitle">Multi-Source Scraper</h1>
      </div>
      <button id="menuToggle" class="menu-toggle" type="button" aria-expanded="false" aria-controls="platformNav">
        <span data-i18n="menuLabel">Plataformas</span>
      </button>
      <nav id="platformNav" class="platform-nav" aria-label="Platform Navigation">
        <button type="button" class="platform-link is-active" data-platform="telegram" data-i18n="navTelegram">
          Telegram
        </button>
        <button type="button" class="platform-link" data-platform="google_maps" data-i18n="navGoogleMaps">
          Google Maps
        </button>
        <button type="button" class="platform-link" data-platform="reddit" data-i18n="navReddit">
          Reddit
        </button>
      </nav>
    </header>

    <main class="page">
      <section class="hero card">
        <div class="hero-top">
          <div>
            <p class="eyebrow">Platform Router</p>
            <h2 data-i18n="heroTitle">Control and Discovery</h2>
            <p class="lede" data-i18n="heroLede">
              Pick a source, set filters and run data collection safely.
            </p>
          </div>
          <div class="toolbar" role="group" aria-label="Preferences">
            <div class="toolbar-field">
              <label for="languageSwitcher" data-i18n="languageLabel">Idioma</label>
              <select id="languageSwitcher" aria-label="Language">
                <option value="es" data-i18n="langSpanish">Espanol</option>
                <option value="en" data-i18n="langEnglish">English</option>
              </select>
            </div>
            <div class="toolbar-field">
              <label for="themeSwitcher" data-i18n="themeLabel">Color</label>
              <select id="themeSwitcher" aria-label="Theme">
                <option value="light" data-i18n="themeLight">Claro</option>
                <option value="dark" data-i18n="themeDark">Oscuro</option>
              </select>
            </div>
          </div>
        </div>
        <div class="metrics">
          <article>
            <span class="label" data-i18n="metricTargetsDb">Targets en DB</span>
            <strong>{{ total_targets }}</strong>
          </article>
          <article>
            <span class="label" data-i18n="metricMessagesStored">Mensajes guardados</span>
            <strong>{{ total_messages }}</strong>
          </article>
          <article>
            <span class="label" data-i18n="metricConfigTargets">Targets configurados</span>
            <strong>{{ config_targets | length }}</strong>
          </article>
        </div>
      </section>

      <section class="card source-card">
        <div class="source-header">
          <h2 data-i18n="sourceSearchTitle">Source Search and Filters</h2>
          <span class="platform-badge" id="activePlatformBadge">Telegram</span>
        </div>
        <form id="sourceFilterForm" class="source-form">
          <div class="source-grid">
            <div class="source-field source-query">
              <label for="sourceQuery" data-i18n="sourceQueryLabel">Search</label>
              <input
                id="sourceQuery"
                type="text"
                autocomplete="off"
                data-i18n-placeholder="sourceQueryPlaceholder"
                placeholder="Ej: restaurantes vegan en Lima"
              />
            </div>

            <div class="source-field">
              <label for="sourceNiche" data-i18n="sourceNicheLabel">Business Niche</label>
              <select id="sourceNiche">
                <option value="all" data-i18n="nicheAll">All Niches</option>
                <option value="restaurants" data-i18n="nicheRestaurants">Restaurants</option>
                <option value="real_estate" data-i18n="nicheRealEstate">Real Estate</option>
                <option value="legal" data-i18n="nicheLegal">Legal Services</option>
                <option value="medical" data-i18n="nicheMedical">Medical Clinics</option>
                <option value="beauty" data-i18n="nicheBeauty">Beauty and Wellness</option>
              </select>
            </div>

            <div class="source-field">
              <label for="hasWebsite" data-i18n="sourceWebsiteLabel">Has Website</label>
              <select id="hasWebsite">
                <option value="any" data-i18n="filterAny">Any</option>
                <option value="yes" data-i18n="filterYes">Yes</option>
                <option value="no" data-i18n="filterNo">No</option>
              </select>
            </div>

            <div class="source-field">
              <label for="hasPhone" data-i18n="sourcePhoneLabel">Has Phone</label>
              <select id="hasPhone">
                <option value="any" data-i18n="filterAny">Any</option>
                <option value="yes" data-i18n="filterYes">Yes</option>
                <option value="no" data-i18n="filterNo">No</option>
              </select>
            </div>

            <div class="source-field">
              <label for="sourceLocation" data-i18n="sourceLocationLabel">Location</label>
              <input
                id="sourceLocation"
                type="text"
                autocomplete="off"
                data-i18n-placeholder="sourceLocationPlaceholder"
                placeholder="Ciudad o pais"
              />
            </div>

            <div class="source-field">
              <label for="minRating" data-i18n="sourceRatingLabel">Minimum Rating</label>
              <select id="minRating">
                <option value="0" data-i18n="ratingAny">Any</option>
                <option value="3">3.0+</option>
                <option value="3.5">3.5+</option>
                <option value="4">4.0+</option>
                <option value="4.5">4.5+</option>
              </select>
            </div>

            <label class="check source-check">
              <input id="onlyVerified" type="checkbox" />
              <span data-i18n="sourceVerifiedLabel">Only verified profiles</span>
            </label>
          </div>

          <div class="source-actions">
            <button type="submit" data-i18n="applyFiltersBtn">Apply Filters</button>
            <button type="button" id="resetFiltersBtn" class="button-secondary" data-i18n="resetFiltersBtn">
              Reset
            </button>
          </div>
          <div id="moduleCredentialWrap" class="source-field" hidden>
            <label id="moduleCredentialLabel" for="moduleCredentialInput" data-i18n="credentialInputLabel">
              Module credential
            </label>
            <input
              id="moduleCredentialInput"
              type="password"
              autocomplete="off"
              data-i18n-placeholder="credentialInputPlaceholder"
              placeholder="Paste API key/token for this source"
            />
            <p id="moduleCredentialHelp" class="small"></p>
          </div>
        </form>
        <p id="sourceHint" class="hint" data-i18n="sourceHintTelegram">
          Telegram module is active. Use public channels/groups or chats where your account already has access.
        </p>
        <p id="capabilityHint" class="hint"></p>
        <pre id="filterPreview" class="filter-preview" data-i18n="filterPreviewEmpty">Configure filters and click Apply.</pre>
        <p id="discoveryFeedback" class="hint"></p>
        <div class="table-wrap">
          <table id="discoveryResultsTable">
            <thead>
              <tr>
                <th data-i18n="discoveryColName">Name</th>
                <th data-i18n="discoveryColWebsite">Website</th>
                <th data-i18n="discoveryColPhone">Phone</th>
                <th data-i18n="discoveryColRating">Rating</th>
                <th data-i18n="discoveryColLocation">Location</th>
                <th data-i18n="discoveryColLink">Source Link</th>
              </tr>
            </thead>
            <tbody id="discoveryResultsBody"></tbody>
          </table>
        </div>
      </section>

      <section class="platform-panel" data-platform="telegram">
        <section class="grid">
          <article class="card">
            <h2 data-i18n="scrapeTitle">Run Scrape</h2>
            <form action="/scrape" method="post" class="stack">
              <label for="target" data-i18n="singleTargetLabel">Single target (optional)</label>
              <input
                id="target"
                name="target"
                type="text"
                data-i18n-placeholder="singleTargetPlaceholder"
                placeholder="@channel or https://t.me/channel"
                autocomplete="off"
              />

              <label class="check">
                <input type="checkbox" name="backfill" />
                <span data-i18n="backfillLabel">Backfill history (up to configured limit)</span>
              </label>
              <label class="check">
                <input type="checkbox" name="dry_run" />
                <span data-i18n="dryRunLabel">Dry-run only (resolve targets, do not scrape)</span>
              </label>
              <button type="submit" data-i18n="startScrapeBtn">Start Scrape</button>
            </form>
            <p class="hint" data-i18n="scrapeHint">
              Supports public targets or chats your account can access legitimately.
            </p>
          </article>

          <article class="card">
            <h2 data-i18n="exportTitle">Export Messages</h2>
            <form action="/export" method="post" class="stack">
              <label for="format" data-i18n="formatLabel">Format</label>
              <select id="format" name="format">
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
              </select>
              <button type="submit" data-i18n="downloadBtn">Download Export</button>
            </form>
            <p class="hint" data-i18n="exportHint">
              Exports the complete messages table from SQLite.
            </p>
          </article>
        </section>

        {% if scrape_error %}
        <section class="card alert error">
          <h2 data-i18n="scrapeErrorTitle">Scrape Error</h2>
          <p>{{ scrape_error }}</p>
        </section>
        {% endif %}

        {% if scrape_summary %}
        <section class="card alert ok">
          <h2 data-i18n="summaryTitle">Last Run Summary</h2>
          <div class="summary">
            <span><span data-i18n="summaryModeLabel">Mode</span>: <strong>{{ scrape_summary.mode }}</strong></span>
            <span><span data-i18n="summaryTargetsOkLabel">Targets OK</span>: <strong>{{ scrape_summary.targets_ok }}/{{ scrape_summary.targets_total }}</strong></span>
            <span><span data-i18n="summaryTargetsFailedLabel">Targets Failed</span>: <strong>{{ scrape_summary.targets_failed }}</strong></span>
            <span><span data-i18n="summaryNewMessagesLabel">New Messages</span>: <strong>{{ scrape_summary.messages_new }}</strong></span>
            <span><span data-i18n="summaryFloodWaitsLabel">Flood Waits</span>: <strong>{{ scrape_summary.flood_waits }}</strong></span>
          </div>

          {% if scrape_summary.dry_run_items %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th data-i18n="dryInput">Input</th>
                  <th data-i18n="dryTargetId">Target ID</th>
                  <th data-i18n="dryResolved">Resolved</th>
                  <th data-i18n="dryLastMessageId">Last Message ID</th>
                </tr>
              </thead>
              <tbody>
                {% for item in scrape_summary.dry_run_items %}
                <tr>
                  <td>{{ item.input_target }}</td>
                  <td>{{ item.resolved_target_id }}</td>
                  <td>{{ item.resolved_username or item.resolved_title or "-" }}</td>
                  <td>{{ item.last_message_id }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </section>
        {% endif %}
      </section>

      <section class="platform-panel" data-platform="google_maps" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="mapsActiveHint">
            Google Maps discovery is active via Google Places API.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="reddit" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="redditActiveHint">
            Reddit discovery is active with official OAuth (public fallback).
          </p>
        </article>
      </section>
    </main>
    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
  </body>
</html>
