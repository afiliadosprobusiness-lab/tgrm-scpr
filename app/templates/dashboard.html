<!doctype html>
<html lang="es" data-theme="ocean">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-i18n="pageTitle">Multi-Source Scraper Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
  </head>
  <body>
    <header class="topnav card">
      <div class="topnav-brand">
        <p class="eyebrow">Data Intake Workspace</p>
        <h1 data-i18n="navTitle">Multi-Source Scraper</h1>
      </div>
      <button id="menuToggle" class="menu-toggle" type="button" aria-expanded="false" aria-controls="platformNav">
        <span data-i18n="menuLabel">Plataformas</span>
      </button>
      <nav id="platformNav" class="platform-nav" aria-label="Platform Navigation">
        <button type="button" class="platform-link is-active" data-platform="telegram" data-i18n="navTelegram">
          Telegram
        </button>
        <button type="button" class="platform-link" data-platform="google_maps" data-i18n="navGoogleMaps">
          Google Maps
        </button>
        <button type="button" class="platform-link" data-platform="openstreetmap" data-i18n="navOpenStreetMap">
          OpenStreetMap
        </button>
        <button type="button" class="platform-link" data-platform="reddit" data-i18n="navReddit">
          Reddit
        </button>
        <button type="button" class="platform-link" data-platform="foursquare" data-i18n="navFoursquare">
          Foursquare
        </button>
        <button type="button" class="platform-link" data-platform="yelp" data-i18n="navYelp">
          Yelp
        </button>
        <button type="button" class="platform-link" data-platform="tomtom" data-i18n="navTomTom">
          TomTom
        </button>
        <button type="button" class="platform-link" data-platform="opencorporates" data-i18n="navOpenCorporates">
          OpenCorporates
        </button>
      </nav>
    </header>

    <main class="page">
      <section class="hero card">
        <div class="hero-top">
          <div>
            <p class="eyebrow">Platform Router</p>
            <h2 data-i18n="heroTitle">Control and Discovery</h2>
            <p class="lede" data-i18n="heroLede">
              Pick a source, set filters and run data collection safely.
            </p>
          </div>
          <div class="toolbar" role="group" aria-label="Preferences">
            <div class="toolbar-field">
              <label for="languageSwitcher" data-i18n="languageLabel">Idioma</label>
              <select id="languageSwitcher" aria-label="Language">
                <option value="es" data-i18n="langSpanish">Espanol</option>
                <option value="en" data-i18n="langEnglish">English</option>
              </select>
            </div>
            <div class="toolbar-field">
              <label for="themeSwitcher" data-i18n="themeLabel">Color</label>
              <select id="themeSwitcher" aria-label="Theme">
                <option value="ocean" data-i18n="themeOcean">Oceano</option>
                <option value="amber" data-i18n="themeAmber">Ambar</option>
                <option value="graphite" data-i18n="themeGraphite">Grafito</option>
              </select>
            </div>
          </div>
        </div>
        <div class="metrics">
          <article>
            <span class="label" data-i18n="metricTargetsDb">Targets en DB</span>
            <strong>{{ total_targets }}</strong>
          </article>
          <article>
            <span class="label" data-i18n="metricMessagesStored">Mensajes guardados</span>
            <strong>{{ total_messages }}</strong>
          </article>
          <article>
            <span class="label" data-i18n="metricConfigTargets">Targets configurados</span>
            <strong>{{ config_targets | length }}</strong>
          </article>
        </div>
      </section>

      <section class="card source-card">
        <div class="source-header">
          <h2 data-i18n="sourceSearchTitle">Source Search and Filters</h2>
          <span class="platform-badge" id="activePlatformBadge">Telegram</span>
        </div>
        <form id="sourceFilterForm" class="source-form">
          <div class="source-grid">
            <div class="source-field source-query">
              <label for="sourceQuery" data-i18n="sourceQueryLabel">Search</label>
              <input
                id="sourceQuery"
                type="text"
                autocomplete="off"
                data-i18n-placeholder="sourceQueryPlaceholder"
                placeholder="Ej: restaurantes vegan en Lima"
              />
            </div>

            <div class="source-field">
              <label for="sourceNiche" data-i18n="sourceNicheLabel">Business Niche</label>
              <select id="sourceNiche">
                <option value="all" data-i18n="nicheAll">All Niches</option>
                <option value="restaurants" data-i18n="nicheRestaurants">Restaurants</option>
                <option value="real_estate" data-i18n="nicheRealEstate">Real Estate</option>
                <option value="legal" data-i18n="nicheLegal">Legal Services</option>
                <option value="medical" data-i18n="nicheMedical">Medical Clinics</option>
                <option value="beauty" data-i18n="nicheBeauty">Beauty and Wellness</option>
              </select>
            </div>

            <div class="source-field">
              <label for="hasWebsite" data-i18n="sourceWebsiteLabel">Has Website</label>
              <select id="hasWebsite">
                <option value="any" data-i18n="filterAny">Any</option>
                <option value="yes" data-i18n="filterYes">Yes</option>
                <option value="no" data-i18n="filterNo">No</option>
              </select>
            </div>

            <div class="source-field">
              <label for="hasPhone" data-i18n="sourcePhoneLabel">Has Phone</label>
              <select id="hasPhone">
                <option value="any" data-i18n="filterAny">Any</option>
                <option value="yes" data-i18n="filterYes">Yes</option>
                <option value="no" data-i18n="filterNo">No</option>
              </select>
            </div>

            <div class="source-field">
              <label for="sourceLocation" data-i18n="sourceLocationLabel">Location</label>
              <input
                id="sourceLocation"
                type="text"
                autocomplete="off"
                data-i18n-placeholder="sourceLocationPlaceholder"
                placeholder="Ciudad o pais"
              />
            </div>

            <div class="source-field">
              <label for="minRating" data-i18n="sourceRatingLabel">Minimum Rating</label>
              <select id="minRating">
                <option value="0" data-i18n="ratingAny">Any</option>
                <option value="3">3.0+</option>
                <option value="3.5">3.5+</option>
                <option value="4">4.0+</option>
                <option value="4.5">4.5+</option>
              </select>
            </div>

            <label class="check source-check">
              <input id="onlyVerified" type="checkbox" />
              <span data-i18n="sourceVerifiedLabel">Only verified profiles</span>
            </label>
          </div>

          <div class="source-actions">
            <button type="submit" data-i18n="applyFiltersBtn">Apply Filters</button>
            <button type="button" id="resetFiltersBtn" class="button-secondary" data-i18n="resetFiltersBtn">
              Reset
            </button>
          </div>
        </form>
        <p id="sourceHint" class="hint" data-i18n="sourceHintTelegram">
          Telegram module is active. Use public channels/groups or chats where your account already has access.
        </p>
        <p id="capabilityHint" class="hint"></p>
        <pre id="filterPreview" class="filter-preview" data-i18n="filterPreviewEmpty">Configure filters and click Apply.</pre>
        <p id="discoveryFeedback" class="hint"></p>
        <div class="table-wrap">
          <table id="discoveryResultsTable">
            <thead>
              <tr>
                <th data-i18n="discoveryColName">Name</th>
                <th data-i18n="discoveryColWebsite">Website</th>
                <th data-i18n="discoveryColPhone">Phone</th>
                <th data-i18n="discoveryColRating">Rating</th>
                <th data-i18n="discoveryColLocation">Location</th>
                <th data-i18n="discoveryColLink">Source Link</th>
              </tr>
            </thead>
            <tbody id="discoveryResultsBody"></tbody>
          </table>
        </div>
      </section>

      <section class="platform-panel" data-platform="telegram">
        <section class="grid">
          <article class="card">
            <h2 data-i18n="scrapeTitle">Run Scrape</h2>
            <form action="/scrape" method="post" class="stack">
              <label for="target" data-i18n="singleTargetLabel">Single target (optional)</label>
              <input
                id="target"
                name="target"
                type="text"
                data-i18n-placeholder="singleTargetPlaceholder"
                placeholder="@channel or https://t.me/channel"
                autocomplete="off"
              />

              <label class="check">
                <input type="checkbox" name="backfill" />
                <span data-i18n="backfillLabel">Backfill history (up to configured limit)</span>
              </label>
              <label class="check">
                <input type="checkbox" name="dry_run" />
                <span data-i18n="dryRunLabel">Dry-run only (resolve targets, do not scrape)</span>
              </label>
              <button type="submit" data-i18n="startScrapeBtn">Start Scrape</button>
            </form>
            <p class="hint" data-i18n="scrapeHint">
              Supports public targets or chats your account can access legitimately.
            </p>
          </article>

          <article class="card">
            <h2 data-i18n="exportTitle">Export Messages</h2>
            <form action="/export" method="post" class="stack">
              <label for="format" data-i18n="formatLabel">Format</label>
              <select id="format" name="format">
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
              </select>
              <button type="submit" data-i18n="downloadBtn">Download Export</button>
            </form>
            <p class="hint" data-i18n="exportHint">
              Exports the complete messages table from SQLite.
            </p>
          </article>
        </section>

        {% if scrape_error %}
        <section class="card alert error">
          <h2 data-i18n="scrapeErrorTitle">Scrape Error</h2>
          <p>{{ scrape_error }}</p>
        </section>
        {% endif %}

        {% if scrape_summary %}
        <section class="card alert ok">
          <h2 data-i18n="summaryTitle">Last Run Summary</h2>
          <div class="summary">
            <span><span data-i18n="summaryModeLabel">Mode</span>: <strong>{{ scrape_summary.mode }}</strong></span>
            <span><span data-i18n="summaryTargetsOkLabel">Targets OK</span>: <strong>{{ scrape_summary.targets_ok }}/{{ scrape_summary.targets_total }}</strong></span>
            <span><span data-i18n="summaryTargetsFailedLabel">Targets Failed</span>: <strong>{{ scrape_summary.targets_failed }}</strong></span>
            <span><span data-i18n="summaryNewMessagesLabel">New Messages</span>: <strong>{{ scrape_summary.messages_new }}</strong></span>
            <span><span data-i18n="summaryFloodWaitsLabel">Flood Waits</span>: <strong>{{ scrape_summary.flood_waits }}</strong></span>
          </div>

          {% if scrape_summary.dry_run_items %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th data-i18n="dryInput">Input</th>
                  <th data-i18n="dryTargetId">Target ID</th>
                  <th data-i18n="dryResolved">Resolved</th>
                  <th data-i18n="dryLastMessageId">Last Message ID</th>
                </tr>
              </thead>
              <tbody>
                {% for item in scrape_summary.dry_run_items %}
                <tr>
                  <td>{{ item.input_target }}</td>
                  <td>{{ item.resolved_target_id }}</td>
                  <td>{{ item.resolved_username or item.resolved_title or "-" }}</td>
                  <td>{{ item.last_message_id }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </section>
        {% endif %}
      </section>

      <section class="platform-panel" data-platform="google_maps" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="mapsActiveHint">
            Google Maps discovery is active via Google Places API.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="openstreetmap" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="osmActiveHint">
            OpenStreetMap discovery is active via Nominatim and Overpass.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="reddit" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="redditActiveHint">
            Reddit discovery is active via public JSON endpoints.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="foursquare" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="foursquareActiveHint">
            Foursquare discovery is active via Places API.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="yelp" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="yelpActiveHint">
            Yelp discovery is active via official Fusion API.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="tomtom" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="tomtomActiveHint">
            TomTom discovery is active via Search API.
          </p>
        </article>
      </section>

      <section class="platform-panel" data-platform="opencorporates" hidden>
        <article class="card integration-card">
          <h2 data-i18n="integrationTitle">Discovery Status</h2>
          <p data-i18n="opencorporatesActiveHint">
            OpenCorporates discovery is active via public company registry API.
          </p>
        </article>
      </section>

      <section class="card">
        <h2 data-i18n="manualTitle">Quick Manual</h2>
        <ol class="manual-list">
          <li data-i18n="manualStep1">Set your credentials in `.env`.</li>
          <li data-i18n="manualStep2">Define `targets` in `config.json`.</li>
          <li data-i18n="manualStep3">Run `Dry-run` first to validate access.</li>
          <li data-i18n="manualStep4">Use incremental scrape for normal operations.</li>
          <li data-i18n="manualStep5">Use backfill only for initial historical loads.</li>
          <li data-i18n="manualStep6">Export CSV/JSON for external analysis.</li>
        </ol>
        <a class="manual-link" href="/manual" target="_blank" rel="noopener" data-i18n="manualOpenLink">
          Open full manual
        </a>
      </section>

      <section class="grid">
        <article class="card">
          <h2 data-i18n="configuredTargetsTitle">Configured Targets</h2>
          {% if config_error %}
          <p class="small error-text">{{ config_error }}</p>
          {% elif not config_targets %}
          <p class="small" data-i18n="noTargetsConfigured">No targets configured.</p>
          {% else %}
          <ul class="list">
            {% for target in config_targets %}
            <li>{{ target }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </article>

        <article class="card">
          <h2 data-i18n="pathsTitle">Paths</h2>
          <ul class="list mono">
            <li>DB: {{ db_path }}</li>
            <li>Config: {{ config_path }}</li>
            <li>Env: {{ env_path }}</li>
          </ul>
        </article>
      </section>

      <section class="card">
        <h2 data-i18n="targetsStatsTitle">Targets Stats</h2>
        {% if not target_rows %}
        <p class="small" data-i18n="noTargetData">No target data yet.</p>
        {% else %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th data-i18n="tableTarget">Target</th>
                <th data-i18n="tableTargetId">Target ID</th>
                <th data-i18n="tableMessages">Messages</th>
                <th data-i18n="tableLastMessageId">Last Message ID</th>
                <th data-i18n="tableLastScrapedAt">Last Scraped At</th>
              </tr>
            </thead>
            <tbody>
              {% for row in target_rows %}
              <tr>
                <td>{{ row.target_username or row.title or row.target_input }}</td>
                <td>{{ row.target_id }}</td>
                <td>{{ row.total_messages }}</td>
                <td>{{ row.last_message_id or 0 }}</td>
                <td>{{ row.last_scraped_at or "never" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>

      <section class="card">
        <h2 data-i18n="recentRunsTitle">Recent Runs</h2>
        {% if not recent_runs %}
        <p class="small" data-i18n="noRunsRegistered">No runs registered.</p>
        {% else %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th data-i18n="tableMode">Mode</th>
                <th data-i18n="tableTargetFilter">Target Filter</th>
                <th data-i18n="tableTargetsOk">Targets OK</th>
                <th data-i18n="tableMessagesNew">Messages New</th>
                <th data-i18n="tableFloodWaits">Flood Waits</th>
                <th data-i18n="tableFinished">Finished</th>
              </tr>
            </thead>
            <tbody>
              {% for run in recent_runs %}
              <tr>
                <td>{{ run.id }}</td>
                <td>{{ run.mode }}</td>
                <td>{{ run.target_filter or "-" }}</td>
                <td>{{ run.targets_ok }}/{{ run.targets_total }}</td>
                <td>{{ run.messages_new }}</td>
                <td>{{ run.flood_waits }}</td>
                <td>{{ run.finished_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>
    </main>
    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
  </body>
</html>
